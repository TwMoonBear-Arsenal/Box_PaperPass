請求事項說明
========
> by carlton0521<br/>
> 請參考網頁: https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows

# 運用構想

- I need AI provide me a Github workflow file. 
- I want to use the action file to be triggered by another workflow then dockerize my app and test it. 

# 擬請AI提供項目

- Please write a Github Action file, named [2.ModuleTest]. This Github action file contains following jobs:
  * Set this action workflow_run after the [1.ModulePackage] actin:
    - if the previous action failed, echo message and complete this action with failure.
    - if the previous action succeeded, echo message and go on following jobs.
  * Get the artifact [package] uploaded from the previous workflow.  
  * Use the dockerfile to build and run a container with local port [2222] bind to container port [22].
  * install pytest in workflow environment.
  * use pytest and [source/Scr_SimpleDemoBox_Test/Scr_SimpleBox_Test.py] to test the container from workflow environment.

# 擬請AI作業流程

## 通用要求:When prepare the data:
- give instructions about how to use this file in the beginning.
- do the work step by step.make it easy to understand for students.
- provide clear explanation with traditional Chinese.

## 通用要求:When respond the data to me
- just show the action files only. If you need any thing for reminding, put it in the action file in comment style.

# 提供AI參考格式

```yaml
# 此 GitHub Workflow 的功能是將指定文件複製到名為 [package] 的文件夾中，並將其打包成 ZIP 文件，以供後續工作流程使用。使用說明：
# 1. 將此文件保存為 .github/workflows/2.ModuleTest.yml。
# 2. 當推送到 main 分支時，此工作流程將自動執行。

name: 2.ModuleTest

on:
  workflow_run:
    workflows: ["1.ModulePackage"]
    types: [completed]

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    steps:
      # 檢查上一個工作流程的狀態
      - name: Check previous workflow status
        id: check_status
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" == "failure" ]; then
            echo "Previous workflow failed. Exiting."
            exit 1
          else
            echo "Previous workflow succeeded. Continuing."
          fi

      # 檢出代碼
      - name: 檢出代碼
        uses: actions/checkout@v2

      # 下載上一個工作流程的產物
      - name: 'Download artifact'
        uses: actions/github-script@v6
        with:
          script: |
            let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
               owner: context.repo.owner,
               repo: context.repo.repo,
               run_id: context.payload.workflow_run.id,
            });
            let matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
              return artifact.name == "package"
            })[0];
            let download = await github.rest.actions.downloadArtifact({
               owner: context.repo.owner,
               repo: context.repo.repo,
               artifact_id: matchArtifact.id,
               archive_format: 'zip',
            });
            let fs = require('fs');
            fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/package.zip`, Buffer.from(download.data));

      # 解壓縮產物
      - name: 'Unzip artifact'
        run: |  
          mkdir package
          unzip package.zip -d package

      # 構建及執行 Docker 容器
      - name: Build and run Docker container
        run: |
          docker build -t myapp ./package
          docker run -d --name myapp-container -p 2222:22 myapp

      # 安裝測試環境 
      - name: Install test environment
        run: |
          sudo apt update
          sudo apt install python3
          sudo apt install python3-pip
          pip3 install pytest
          pip3 install paramiko
          pytest --version

      # 執行測試
      - name: 執行容器外測試
        run: |  
          pwd
          ls -al
          pytest ./source/Scr_SimpleDemoBox_Test/Scr_SimpleBox_Test.py

      # 測試通過打包上傳(github強制zip)
      - name: 上傳打包文件
        uses: actions/upload-artifact@v4
        with:
          name: package 
          path: package
```